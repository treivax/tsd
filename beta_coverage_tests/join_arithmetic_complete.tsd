// Test complet des opérateurs arithmétiques dans jointures beta (2+ variables)
// Couvre: opérateurs de base, expressions complexes, fonctions mathématiques, parenthèses

type Product : <id: string, price: number, cost: number, discount: number, quantity: number>
type Order : <id: string, product_id: string, quantity: number, tax_rate: number, shipping: number>

// === SECTION 1: Opérateurs de base avec 2 variables ===

// Test 1: Addition simple entre 2 variables
rule r1 : {p: Product, o: Order} / p.id == o.product_id AND p.price + o.shipping > 100 ==> expensive_with_shipping(p.id, o.id)

// Test 2: Soustraction entre 2 variables
rule r2 : {p: Product, o: Order} / p.id == o.product_id AND p.price - p.cost > o.shipping ==> profitable_after_shipping(p.id, o.id)

// Test 3: Multiplication entre 2 variables
rule r3 : {p: Product, o: Order} / p.id == o.product_id AND p.price * o.quantity > 500 ==> bulk_order_value(p.id, o.id)

// Test 4: Division entre 2 variables
rule r4 : {p: Product, o: Order} / p.id == o.product_id AND p.price / o.quantity < 20 ==> low_unit_price(p.id, o.id)

// === SECTION 2: Expressions complexes avec priorité ===

// Test 5: Priorité multiplication avant addition
rule r5 : {p: Product, o: Order} / p.id == o.product_id AND p.price + o.shipping * o.tax_rate > 150 ==> priority_test(p.id, o.id)

// Test 6: Parenthèses forcent priorité
rule r6 : {p: Product, o: Order} / p.id == o.product_id AND (p.price + o.shipping) * o.tax_rate > 20 ==> forced_priority(p.id, o.id)

// Test 7: Parenthèses multiples imbriquées
rule r7 : {p: Product, o: Order} / p.id == o.product_id AND ((p.price - p.cost) * o.quantity) + o.shipping > 100 ==> profit_with_shipping(p.id, o.id)

// Test 8: Chaîne d'additions/soustractions (gauche à droite)
rule r8 : {p: Product, o: Order} / p.id == o.product_id AND p.price + o.shipping - p.discount - o.tax_rate > 50 ==> chain_operations(p.id, o.id)

// Test 9: Combinaison multiplication/division
rule r9 : {p: Product, o: Order} / p.id == o.product_id AND p.price * o.quantity / p.cost > 2 ==> margin_ratio(p.id, o.id)

// === SECTION 3: Fonctions mathématiques avec 2 variables ===

// Test 10: ABS - valeur absolue de différence
rule r10 : {p: Product, o: Order} / p.id == o.product_id AND ABS(p.price - o.shipping) < 10 ==> similar_values(p.id, o.id)

// Test 11: ROUND avec calcul
rule r11 : {p: Product, o: Order} / p.id == o.product_id AND ROUND(p.price / o.quantity) == 25 ==> rounded_unit_25(p.id, o.id)

// Test 12: FLOOR avec expression
rule r12 : {p: Product, o: Order} / p.id == o.product_id AND FLOOR((p.price - p.discount) / o.quantity) >= 10 ==> floor_unit_min_10(p.id, o.id)

// Test 13: CEIL avec division
rule r13 : {p: Product, o: Order} / p.id == o.product_id AND CEIL(o.quantity / p.quantity) == 3 ==> needs_3_batches(p.id, o.id)

// Test 14: Fonctions imbriquées
rule r14 : {p: Product, o: Order} / p.id == o.product_id AND ROUND(ABS(p.price - o.shipping)) < 5 ==> nested_functions(p.id, o.id)

// === SECTION 4: Expressions dans actions (calculs de résultats) ===

// Test 15: Addition dans action
rule r15 : {p: Product, o: Order} / p.id == o.product_id AND p.price > 0 ==> total_with_shipping(p.id, o.id, p.price + o.shipping)

// Test 16: Multiplication dans action (total commande)
rule r16 : {p: Product, o: Order} / p.id == o.product_id AND o.quantity > 0 ==> order_total(p.id, o.id, p.price * o.quantity)

// Test 17: Expression complexe dans action
rule r17 : {p: Product, o: Order} / p.id == o.product_id AND p.price > 0 ==> final_price(p.id, o.id, (p.price - p.discount) * o.quantity + o.shipping)

// Test 18: Fonction mathématique dans action
rule r18 : {p: Product, o: Order} / p.id == o.product_id AND p.price > 0 ==> rounded_unit_price(p.id, o.id, ROUND(p.price / o.quantity))

// Test 19: Multiples calculs dans action
rule r19 : {p: Product, o: Order} / p.id == o.product_id AND p.price > 0 ==> order_details(p.id, o.id, p.price * o.quantity, (p.price - p.cost) * o.quantity, CEIL(o.quantity / p.quantity))

# Faits pour join_arithmetic_complete.constraint
# 3 produits et 6 commandes pour tester toutes les combinaisons

# Produits avec prix, coût, remise, quantité de base
Product(id:"PROD001", price:100, cost:60, discount:10, quantity:5)
Product(id:"PROD002", price:50, cost:30, discount:5, quantity:10)
Product(id:"PROD003", price:200, cost:150, discount:20, quantity:2)

# Commandes variées pour tester différents cas
# Commande 1: Grande quantité, faible shipping
Order(id:"ORD001", product_id:"PROD001", quantity:10, tax_rate:0.2, shipping:15)

# Commande 2: Petite quantité, shipping élevé
Order(id:"ORD002", product_id:"PROD001", quantity:2, tax_rate:0.1, shipping:25)

# Commande 3: Quantité multiple exacte
Order(id:"ORD003", product_id:"PROD002", quantity:30, tax_rate:0.15, shipping:10)

# Commande 4: Division avec reste
Order(id:"ORD004", product_id:"PROD002", quantity:25, tax_rate:0.2, shipping:8)

# Commande 5: Grande commande produit cher
Order(id:"ORD005", product_id:"PROD003", quantity:6, tax_rate:0.25, shipping:50)

# Commande 6: Petite commande
Order(id:"ORD006", product_id:"PROD003", quantity:1, tax_rate:0.1, shipping:5)
