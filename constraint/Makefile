# Makefile pour le module Constraint refactorisÃ©
# Usage: make [target]

.PHONY: help test coverage clean validate build format lint test-new

# Affichage de l'aide par dÃ©faut
help:
	@echo "ğŸ¯ Module Constraint - Commandes disponibles:"
	@echo ""
	@echo "ğŸ—ï¸  CONSTRUCTION:"
	@echo "  build      - Compiler tous les packages"
	@echo "  parser     - RÃ©gÃ©nÃ©rer le parser depuis la grammaire PEG"
	@echo ""
	@echo "ğŸ§ª TESTS:"
	@echo "  test       - Tests rapides (anciens tests)"
	@echo "  test-new   - Tests complets nouvelle architecture"
	@echo "  coverage   - GÃ©nÃ©rer rapport de couverture dÃ©taillÃ©"
	@echo ""
	@echo "ğŸ” VALIDATION:"
	@echo "  validate   - Valider la nouvelle architecture"
	@echo "  format     - Formater le code Go"
	@echo "  lint       - Analyser le code avec go vet"
	@echo ""
	@echo "ğŸ§¹ MAINTENANCE:"
	@echo "  clean      - Nettoyer les artefacts temporaires"
	@echo "  deps       - Installer les dÃ©pendances de dÃ©veloppement"
	@echo ""
	@echo "ğŸ“ Structure refactorisÃ©e:"
	@echo "  pkg/domain/    - Types fondamentaux et erreurs"
	@echo "  pkg/validator/ - Validation et vÃ©rification"
	@echo "  internal/      - Configuration interne"
	@echo "  test/          - Tests organisÃ©s"
	@echo "  scripts/       - Scripts d'automatisation"

# Construction complÃ¨te
build:
	@echo "ğŸ”¨ Construction du module constraint..."
	@./scripts/build.sh

# GÃ©nÃ©ration du parser depuis PEG
parser:
	@echo "ğŸ“¦ RÃ©gÃ©nÃ©ration du parser..."
	@export PATH=$$PATH:~/go/bin && pigeon -o parser.go grammar/constraint.peg
	@echo "âœ… Parser rÃ©gÃ©nÃ©rÃ© avec succÃ¨s"

# Tests anciens (compatibilitÃ©)
test:
	@echo "ğŸ§ª Tests rapides (anciens)..."
	@go test -v . || echo "âš ï¸  Tests anciens nÃ©cessitent adaptation"

# Tests nouvelle architecture
test-new:
	@./scripts/run_tests_new.sh

# Couverture dÃ©taillÃ©e
coverage:
	@echo "ğŸ“Š GÃ©nÃ©ration de la couverture dÃ©taillÃ©e..."
	@go test -coverprofile=test/coverage/coverage.out ./pkg/... ./internal/...
	@go tool cover -html=test/coverage/coverage.out -o test/coverage/reports/coverage.html
	@echo "âœ… Rapport disponible: test/coverage/reports/coverage.html"
	@go tool cover -func=test/coverage/coverage.out | tail -1

# Validation de l'architecture
validate:
	@./scripts/validate.sh

# Formatage du code
format:
	@echo "âœ¨ Formatage du code Go..."
	@go fmt ./...
	@echo "âœ… Code formatÃ©"

# Analyse statique
lint:
	@echo "ğŸ” Analyse du code..."
	@go vet ./...
	@echo "âœ… Analyse terminÃ©e"

# Nettoyage
clean:
	@./scripts/clean.sh

# Tests rapides (sans couverture)
test-quick:
	@echo "âš¡ Tests rapides..."
	@go test -short ./pkg/...
	@echo "âœ… Tests rapides terminÃ©s"

# Installation des dÃ©pendances de dÃ©veloppement
deps:
	@echo "ğŸ“¦ Installation des outils de dÃ©veloppement..."
	@go install github.com/mna/pigeon@latest || echo "âš ï¸ Erreur d'installation de pigeon"
	@echo "âœ… Outils installÃ©s"

# Statistiques du projet
stats:
	@echo "ğŸ“Š Statistiques du projet:"
	@echo ""
	@echo "ğŸ“ Structure:"
	@echo "  Packages Go: $$(find pkg internal -name '*.go' | wc -l) fichiers"
	@echo "  Tests: $$(find test -name '*.go' | wc -l) fichiers"
	@echo "  Scripts: $$(find scripts -name '*.sh' | wc -l) scripts"
	@echo ""
	@echo "ğŸ“ˆ Couverture actuelle:"
	@go test -coverprofile=/tmp/constraint_stats.out ./pkg/... >/dev/null 2>&1 && go tool cover -func=/tmp/constraint_stats.out | tail -1 || echo "  Erreur de calcul"
	@rm -f /tmp/constraint_stats.out 2>/dev/null || true

# Compilation pour diffÃ©rents OS (si nÃ©cessaire)
build-all:
	@echo "ğŸŒ Construction multi-plateforme..."
	@GOOS=linux GOARCH=amd64 go build -o bin/constraint-parser-linux-amd64 ./cmd/
	@GOOS=windows GOARCH=amd64 go build -o bin/constraint-parser-windows-amd64.exe ./cmd/
	@GOOS=darwin GOARCH=amd64 go build -o bin/constraint-parser-darwin-amd64 ./cmd/
	@echo "âœ… Binaires crÃ©Ã©s dans bin/"

# Pipeline CI/CD (simulation)
ci:
	@echo "ğŸš€ Pipeline CI/CD simulÃ©..."
	@make deps
	@make format
	@make lint
	@make build
	@make test-new
	@make validate
	@echo "âœ… Pipeline rÃ©ussi !"
