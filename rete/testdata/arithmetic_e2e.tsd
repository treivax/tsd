// Test E2E: Expressions arithmetiques complexes dans les actions
// Ce fichier teste les expressions arithmetiques avec imbrication et operateurs multiples

// Definition des types
type Produit(#id: string, prix: number, quantite: number, poids: number)
type Commande(#id: string, produit: Produit, qte: number, remise: number)
type Client(#id: string, niveau: string, reduction_supplementaire: number)

// Definition des actions
action facture_calculee(
    commande_id: string,
    total_brut: number,
    montant_remise: number,
    total_net: number,
    prix_par_unite: number,
    cout_livraison: number
)

action facture_speciale(commande_id: string, message: string, montant: number)

// Regle 1: Condition de base (devrait declencher l'action pour toutes les commandes)
// c.produit == p : condition de jointure par référence de fait
// c.qte * 23 - 10 > 0 : condition alpha arithmetique (toujours vraie pour nos donnees)
rule calcul_facture_base : {p: Produit, c: Commande} /
    c.produit == p AND (c.qte * 23 - 10 + c.remise * 43) > 0
    ==> facture_calculee(
        c.id,
        p.prix * c.qte,
        (p.prix * c.qte) * (c.remise / 100),
        (p.prix * c.qte) - ((p.prix * c.qte) * (c.remise / 100)),
        p.prix,
        (p.poids * c.qte) + 10
    )

// Regle 2: Condition inversée par rapport à la règle 1
// Les deux regles ne doivent pas partager le MEME JoinNode car conditions alpha différentes
rule calcul_facture_speciale : {p: Produit, c: Commande} /
    c.produit == p AND (c.qte * 23 - 10 + c.remise * 43) < 0
    ==> facture_speciale(
        c.id,
        "Commande speciale",
        p.prix * c.qte * 1.1
    )

// Regle 3: MEME condition de jointure ET meme condition alpha que la règle 1
// Doit REUTILISER le même JoinNode que la règle 1
rule calcul_facture_premium : {p: Produit, c: Commande} /
    c.produit == p AND (c.qte * 23 - 10 + c.remise * 43) > 0
    ==> facture_calculee(
        c.id,
        p.prix * c.qte * 1.2,
        (p.prix * c.qte * 1.2) * (c.remise / 100),
        (p.prix * c.qte * 1.2) - ((p.prix * c.qte * 1.2) * (c.remise / 100)),
        p.prix * 1.2,
        (p.poids * c.qte) + 20
    )

// Données de test avec affectations de variables
p1 = Produit(id: "PROD001", prix: 100.0, quantite: 10, poids: 2.5)
p2 = Produit(id: "PROD002", prix: 50.0, quantite: 20, poids: 1.0)
p3 = Produit(id: "PROD003", prix: 200.0, quantite: 5, poids: 5.0)

Commande(id: "CMD001", produit: p1, qte: 2, remise: 10.0)
Commande(id: "CMD002", produit: p2, qte: 5, remise: 5.0)
Commande(id: "CMD003", produit: p3, qte: 1, remise: 15.0)

Client(id: "CLI001", niveau: "gold", reduction_supplementaire: 5.0)
Client(id: "CLI002", niveau: "silver", reduction_supplementaire: 3.0)
