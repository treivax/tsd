name: ğŸ§ª Test Coverage Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-coverage:
    name: ğŸ“Š Test Coverage Analysis
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¦ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ¹ Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: ğŸ“Š Cache Go modules
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: ğŸ“¥ Install dependencies
      run: go mod download

    - name: ğŸ§ª Run tests with coverage (all code)
      run: |
        echo "ğŸ“Š Running all tests with coverage..."
        go test -coverprofile=coverage-all.out ./...

    - name: ğŸ§ª Run tests with coverage (production code only)
      run: |
        echo "ğŸ“Š Running production tests (excluding examples)..."
        go test -coverprofile=coverage-prod.out $(go list ./... | grep -v '/examples' | grep -v '/testutil')

    - name: ğŸ“ˆ Calculate coverage
      id: coverage
      run: |
        # Coverage globale (tout le code)
        COVERAGE_ALL=$(go tool cover -func=coverage-all.out | grep total | awk '{print $3}' | sed 's/%//')
        echo "coverage_all=$COVERAGE_ALL" >> $GITHUB_OUTPUT
        echo "ğŸ“Š Coverage (all code): $COVERAGE_ALL%"

        # Coverage production (sans exemples)
        COVERAGE_PROD=$(go tool cover -func=coverage-prod.out | grep total | awk '{print $3}' | sed 's/%//')
        echo "coverage_prod=$COVERAGE_PROD" >> $GITHUB_OUTPUT
        echo "ğŸ“Š Coverage (production): $COVERAGE_PROD%"

    - name: âœ… Validate production coverage threshold
      run: |
        COVERAGE_PROD=${{ steps.coverage.outputs.coverage_prod }}
        THRESHOLD=80.0

        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“Š COVERAGE VALIDATION"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "Production Coverage: $COVERAGE_PROD%"
        echo "Minimum Threshold:   $THRESHOLD%"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

        if (( $(echo "$COVERAGE_PROD < $THRESHOLD" | bc -l) )); then
          echo "âŒ FAILED: Coverage ($COVERAGE_PROD%) is below threshold ($THRESHOLD%)"
          exit 1
        else
          echo "âœ… PASSED: Coverage meets or exceeds threshold"
        fi

    - name: âš ï¸ Check for coverage regression
      if: github.event_name == 'pull_request'
      run: |
        # RÃ©cupÃ©rer la couverture de la branche main
        git fetch origin main:main
        git checkout main
        go test -coverprofile=coverage-main.out $(go list ./... | grep -v '/examples' | grep -v '/testutil') 2>/dev/null || echo "0" > coverage-main.out
        COVERAGE_MAIN=$(go tool cover -func=coverage-main.out 2>/dev/null | grep total | awk '{print $3}' | sed 's/%//' || echo "0")
        git checkout -

        COVERAGE_PR=${{ steps.coverage.outputs.coverage_prod }}

        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“Š REGRESSION CHECK"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "Main branch coverage:    $COVERAGE_MAIN%"
        echo "PR branch coverage:      $COVERAGE_PR%"

        DIFF=$(echo "$COVERAGE_PR - $COVERAGE_MAIN" | bc -l)
        echo "Difference:              $DIFF%"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

        # TolÃ©rance de -1% pour Ã©viter les faux positifs
        if (( $(echo "$DIFF < -1.0" | bc -l) )); then
          echo "âš ï¸ WARNING: Coverage decreased by more than 1%"
          echo "Please add tests to maintain coverage level"
          # Ne pas Ã©chouer le build, juste avertir
        elif (( $(echo "$DIFF > 0" | bc -l) )); then
          echo "âœ… Coverage improved by $DIFF%!"
        else
          echo "âœ… Coverage maintained"
        fi

    - name: ğŸ“Š Coverage by module
      run: |
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“Š COVERAGE BY MODULE (Production Code)"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        go test -cover $(go list ./... | grep -v '/examples' | grep -v '/testutil') | grep -E "ok|coverage:" | grep -v "0.0% of statements"
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    - name: ğŸ“Š Modules below 80%
      run: |
        echo ""
        echo "âš ï¸  MODULES BELOW 80% COVERAGE:"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        go test -cover $(go list ./... | grep -v '/examples' | grep -v '/testutil') 2>&1 | \
          grep "coverage:" | \
          awk '{
            match($0, /coverage: ([0-9.]+)%/, arr);
            if (arr[1] > 0 && arr[1] < 80) {
              print $2, arr[1]"%"
            }
          }' | \
          sort -k2 -n || echo "âœ… All production modules have >80% coverage!"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    - name: ğŸ“ˆ Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage-prod.out
        flags: production
        name: codecov-production
        fail_ci_if_error: false

    - name: ğŸ“Š Generate coverage HTML report
      run: |
        go tool cover -html=coverage-prod.out -o coverage-prod.html
        echo "âœ… Coverage report generated: coverage-prod.html"

    - name: ğŸ“¤ Upload coverage report artifact
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: coverage-prod.html
        retention-days: 30

    - name: ğŸ Summary
      run: |
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âœ… TEST COVERAGE VALIDATION COMPLETE"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“Š All Code Coverage:        ${{ steps.coverage.outputs.coverage_all }}%"
        echo "ğŸ“Š Production Code Coverage: ${{ steps.coverage.outputs.coverage_prod }}%"
        echo "ğŸ¯ Minimum Threshold:        80.0%"
        echo "âœ… Status:                   PASSED"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸ“Š Coverage report available in artifacts"
        echo "ğŸ“ˆ Coverage data uploaded to Codecov"
        echo ""
